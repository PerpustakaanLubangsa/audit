<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audit Live - Fixed & Optimized</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<style>
body { background-color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
#toastContainer {
position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 8px;
pointer-events: none; width: 100%;
}
@keyframes elegantSlideUp {
0% { transform: translateY(20px); opacity: 0; }
100% { transform: translateY(0); opacity: 1; }
}
.toast-elegant { 
animation: elegantSlideUp 0.3s ease-out forwards; 
pointer-events: auto; min-width: 250px;
}
@keyframes degImpact {
0% { transform: scale(0.98); background-color: rgba(6, 182, 212, 0.2); }
100% { transform: scale(1); background-color: white; }
}
.new-row-deg { 
animation: degImpact 0.4s ease-out forwards;
border-left: 4px solid #0891b2 !important;
}
.excel-table { border-collapse: collapse; width: 100%; font-size: 13px; table-layout: fixed; }
.excel-table th { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 12px; text-align: left; color: #64748b; text-transform: uppercase; font-size: 10px; font-weight: 800; }
.excel-table td { border: 1px solid #e2e8f0; padding: 10px 14px; background: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.sticky-header { position: sticky; top: 0; z-index: 20; }
.vibrate-success { animation: shake 0.2s ease-in-out; }
@keyframes shake {
0%, 100% { transform: translateX(0); }
25% { transform: translateX(-4px); }
75% { transform: translateX(4px); }
}
</style>
</head>
<body class="p-4">
<div class="max-w-5xl mx-auto h-[95vh] flex flex-col">
<div id="toastContainer"></div>
<header class="flex justify-between items-center mb-4 bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
<div class="flex items-center gap-4">
<div class="bg-cyan-600 p-2.5 rounded-xl shadow-lg shadow-cyan-100">
<i class="fa-solid fa-bolt-lightning text-white text-sm"></i>
</div>
<div>
<h1 class="text-xl font-extrabold text-slate-800 tracking-tighter uppercase leading-none">Audit Impact</h1>
<p id="statusInfo" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1 italic">Initializing...</p>
</div>
</div>
<div class="flex flex-col items-end gap-1">
<div class="flex items-center gap-4">
<div class="text-right">
<span id="counter" class="text-3xl font-black text-slate-800 tabular-nums">0</span>
<p class="text-[9px] font-black text-cyan-600 uppercase">My Items</p>
</div>
<button id="clearDataBtn" class="bg-rose-50 hover:bg-rose-100 text-rose-600 p-3 rounded-xl transition-colors border border-rose-100">
<i class="fa-solid fa-trash-can"></i>
</button>
</div>
<div id="speedStats" class="text-[10px] font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-lg flex gap-3">
<span>YOU: <span id="mySpeed" class="text-cyan-600">0%</span></span>
<span>OTHERS: <span id="otherSpeed" class="text-rose-500">0%</span></span>
</div>
</div>
</header>
<div class="relative mb-4" id="inputWrapper">
<div class="absolute inset-y-0 left-5 flex items-center pointer-events-none">
<i class="fa-solid fa-barcode text-cyan-600 text-lg"></i>
</div>
<input type="text" id="scanInput" autocomplete="off"
class="w-full pl-14 pr-4 py-4 bg-white border-2 border-slate-200 rounded-xl shadow-sm focus:border-cyan-500 focus:ring-4 focus:ring-cyan-500/5 outline-none font-mono text-lg transition-all" 
placeholder="Scan or type manual...">
</div>
<div class="bg-white rounded-2xl shadow-xl border border-slate-200 flex-grow overflow-hidden flex flex-col">
<div class="overflow-y-auto flex-grow" id="scrollArea">
<table class="excel-table">
<thead class="sticky-header">
<tr>
<th width="80">Rak</th>
<th>Judul Buku</th>
<th width="150">Penulis</th>
<th width="150">Barcode</th>
<th width="80">Aksi</th>
</tr>
</thead>
<tbody id="auditTable">
<tr id="emptyMsg">
<td colspan="5" class="p-20 text-center text-slate-300 italic font-bold uppercase tracking-widest">No scans yet</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<script>
const SB_URL = 'https://heosadzwckwmbjhxydtm.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhlb3NhZHp3Y2t3bWJqaHh5ZHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMDk5MDMsImV4cCI6MjA4Mjc4NTkwM30.4tUQQNsczDqX6xuzvq8C5JncxvX_RAdwr95xMaWIvhY';
const client = supabase.createClient(SB_URL, SB_KEY);
const DEVICE_ID = localStorage.getItem('device_id') || 'dev_' + Math.random().toString(36).substr(2, 9);
localStorage.setItem('device_id', DEVICE_ID);
let scannedLogs = [];
let typingTimer;
const doneTypingInterval = 350; 
function showToast(msg, type = 'success') {
const container = document.getElementById('toastContainer');
const toast = document.createElement('div');
const styles = {
success: { bg: 'bg-cyan-600', icon: 'fa-check' },
error: { bg: 'bg-rose-600', icon: 'fa-xmark' },
warning: { bg: 'bg-amber-500', icon: 'fa-triangle-exclamation' }
};
toast.className = `${styles[type].bg} text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-3 toast-elegant`;
toast.innerHTML = `<i class="fa-solid ${styles[type].icon} text-xs"></i><span class="font-bold text-[10px] uppercase tracking-wider">${msg}</span>`;
container.prepend(toast);
setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 400); }, 2000);
}
function triggerHaptic() {
if ("vibrate" in navigator) navigator.vibrate(50);
document.getElementById('inputWrapper').classList.add('vibrate-success');
setTimeout(() => document.getElementById('inputWrapper').classList.remove('vibrate-success'), 200);
}
async function updateStats() {
const { data, error } = await client.from('log_audit').select('device_id');
if (error || !data) return;
const total = data.length;
if (total === 0) return;
const myCount = data.filter(x => x.device_id === DEVICE_ID).length;
const othersCount = total - myCount;
document.getElementById('mySpeed').innerText = ((myCount / total) * 100).toFixed(1) + '%';
document.getElementById('otherSpeed').innerText = ((othersCount / total) * 100).toFixed(1) + '%';
}
function renderTable(isNewEntry = false) {
const tbody = document.getElementById('auditTable');
const counterEl = document.getElementById('counter');
if (scannedLogs.length === 0) {
tbody.innerHTML = `<tr id="emptyMsg"><td colspan="5" class="p-20 text-center text-slate-300 italic font-bold uppercase tracking-widest">No scans yet</td></tr>`;
counterEl.innerText = '0';
return;
}
const displayList = scannedLogs.slice(0, 10);
tbody.innerHTML = displayList.map((log, index) => `
<tr class="${(isNewEntry && index === 0) ? 'new-row-deg' : ''}">
<td class="font-bold text-cyan-700 font-mono text-[11px]">${log.lokasi_rak || '-'}</td>
<td class="font-bold text-slate-700 uppercase text-[10px]">${log.judul_buku}</td>
<td class="text-slate-500 text-[10px]">${log.penulis || '-'}</td>
<td class="font-mono text-[10px] text-slate-400 font-bold">${log.kode_barcode}</td>
<td class="text-center">
<button onclick="deleteEntry(${log.id})" class="text-rose-400 hover:text-rose-600 transition-colors">
<i class="fa-solid fa-trash-can text-xs"></i>
</button>
</td>
</tr>
`).join('');
counterEl.innerText = scannedLogs.length;
updateStats();
}
async function processBarcode() {
const inputEl = document.getElementById('scanInput');
const barcode = inputEl.value.trim().toUpperCase();
if (!barcode || barcode.length < 3) return;
inputEl.value = '';
clearTimeout(typingTimer);
if (scannedLogs.some(l => l.kode_barcode === barcode)) {
showToast("Duplicate Entry!", "warning");
return;
}
const { data: buku, error } = await client.from('ekslempar').select('kode, lokasi_rak, biblio(judul, penulis)').eq('kode', barcode).maybeSingle();
if (error || !buku) {
showToast("Barcode not found!", "error");
return;
}
const payload = {
kode_barcode: barcode,
judul_buku: buku.biblio?.judul || 'No Title',
penulis: buku.biblio?.penulis || '-',
lokasi_rak: buku.lokasi_rak || '-',
device_id: DEVICE_ID
};
const { data: insertedData, error: insertError } = await client.from('log_audit').insert([payload]).select().single();
if (!insertError && insertedData) {
scannedLogs.unshift(insertedData);
renderTable(true);
triggerHaptic();
showToast("Audit Success!");
} else {
showToast("Save Failed!", "error");
}
}
async function deleteEntry(id) {
const { error } = await client.from('log_audit').delete().eq('id', id);
if (!error) {
scannedLogs = scannedLogs.filter(log => log.id !== id);
renderTable();
showToast("Entry Deleted", "warning");
} else {
showToast("Delete Failed", "error");
}
}
async function clearAllData() {
if (confirm("Hapus seluruh data audit milik Anda?")) {
const { error } = await client.from('log_audit').delete().eq('device_id', DEVICE_ID);
if (!error) {
scannedLogs = [];
renderTable();
showToast("Your data cleared", "error");
}
}
}
const inputField = document.getElementById('scanInput');
inputField.addEventListener('keyup', (e) => {
clearTimeout(typingTimer);
if (e.key === 'Enter') processBarcode();
else typingTimer = setTimeout(processBarcode, doneTypingInterval);
});
document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
client.channel('audit-channel')
.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'log_audit' }, payload => {
updateStats();
})
.on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'log_audit' }, payload => {
if (payload.old.device_id === DEVICE_ID || scannedLogs.some(x => x.id === payload.old.id)) {
scannedLogs = scannedLogs.filter(x => x.id !== payload.old.id);
renderTable();
}
updateStats();
})
.subscribe();
window.onload = async () => {
inputField.focus();
const { data } = await client.from('log_audit').select('*').eq('device_id', DEVICE_ID).order('created_at', { ascending: false });
if (data) { scannedLogs = data; renderTable(); }
document.getElementById('statusInfo').innerHTML = '<span class="text-green-500">‚óè</span> System Live';
updateStats();
};
document.addEventListener('click', (e) => {
if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
inputField.focus();
}
});
</script>
</body>
</html>
